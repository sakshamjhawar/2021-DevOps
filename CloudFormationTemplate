{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Metadata": {
        "AWS::CloudFormation::Designer": {
            "ac93efbc-3f9d-4b15-a971-8c409e59459e": {
                "size": {
                    "width": 690,
                    "height": 690
                },
                "position": {
                    "x": -350,
                    "y": -180
                },
                "z": 1,
                "embeds": [
                    "921ba23d-e105-41cf-bd2f-278da2b3535f",
                    "69af8e10-be30-4201-a6fc-23a307cc084a",
                    "ad71c22b-9978-4aa9-a3b2-e8afc2bcd1da",
                    "fba73ebe-558c-4800-bc0d-9cf084e4d781",
                    "0359154e-dc8d-4729-8a09-9a07ce8d7e02"
                ]
            },
            "0359154e-dc8d-4729-8a09-9a07ce8d7e02": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 50,
                    "y": 240
                },
                "z": 2,
                "parent": "ac93efbc-3f9d-4b15-a971-8c409e59459e",
                "embeds": [],
                "iscontainedinside": [
                    "fba73ebe-558c-4800-bc0d-9cf084e4d781"
                ],
                "dependson": [
                    "f79965dd-2ac1-4a71-8c6c-95819d1642f7"
                ]
            },
            "fba73ebe-558c-4800-bc0d-9cf084e4d781": {
                "size": {
                    "width": 150,
                    "height": 150
                },
                "position": {
                    "x": 150,
                    "y": -120
                },
                "z": 2,
                "parent": "ac93efbc-3f9d-4b15-a971-8c409e59459e",
                "embeds": [],
                "iscontainedinside": [
                    "ac93efbc-3f9d-4b15-a971-8c409e59459e",
                    "ac93efbc-3f9d-4b15-a971-8c409e59459e",
                    "ac93efbc-3f9d-4b15-a971-8c409e59459e"
                ]
            },
            "48858278-cbff-4117-8da1-34eb3bf67b64": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 150,
                    "y": 300
                },
                "z": 1,
                "embeds": [],
                "iscontainedinside": [
                    "ac93efbc-3f9d-4b15-a971-8c409e59459e"
                ]
            },
            "f79965dd-2ac1-4a71-8c6c-95819d1642f7": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 90,
                    "y": 420
                },
                "z": 1,
                "embeds": []
            },
            "b8b4d6f9-cbc9-4878-a138-7d9cda08973b": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 60,
                    "y": 330
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "f79965dd-2ac1-4a71-8c6c-95819d1642f7"
                ]
            },
            "ef28d194-441d-430e-ba53-8be6db7a7c74": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 150,
                    "y": 420
                },
                "z": 1,
                "embeds": [],
                "isassociatedwith": [
                    "f79965dd-2ac1-4a71-8c6c-95819d1642f7"
                ]
            },
            "aabb2d30-64d9-40f1-be5d-19e5d304aced": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 210,
                    "y": 270
                },
                "z": 1,
                "embeds": []
            },
            "921ba23d-e105-41cf-bd2f-278da2b3535f": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": 190,
                    "y": 160
                },
                "z": 2,
                "parent": "ac93efbc-3f9d-4b15-a971-8c409e59459e",
                "embeds": []
            },
            "c8727300-fbdb-455f-acc8-5d3c90266ba2": {
                "source": {
                    "id": "ac93efbc-3f9d-4b15-a971-8c409e59459e"
                },
                "target": {
                    "id": "921ba23d-e105-41cf-bd2f-278da2b3535f"
                },
                "z": 2
            },
            "69af8e10-be30-4201-a6fc-23a307cc084a": {
                "size": {
                    "width": 330,
                    "height": 240
                },
                "position": {
                    "x": -320,
                    "y": -120
                },
                "z": 2,
                "parent": "ac93efbc-3f9d-4b15-a971-8c409e59459e",
                "embeds": [
                    "0550ae34-a326-4bbf-863e-64ee16839d20",
                    "671c2539-9f72-4e31-a2bf-b22626105d41"
                ],
                "iscontainedinside": [
                    "ac93efbc-3f9d-4b15-a971-8c409e59459e",
                    "ac93efbc-3f9d-4b15-a971-8c409e59459e",
                    "ac93efbc-3f9d-4b15-a971-8c409e59459e"
                ]
            },
            "0550ae34-a326-4bbf-863e-64ee16839d20": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -290,
                    "y": -60
                },
                "z": 3,
                "parent": "69af8e10-be30-4201-a6fc-23a307cc084a",
                "embeds": [],
                "iscontainedinside": [
                    "69af8e10-be30-4201-a6fc-23a307cc084a",
                    "69af8e10-be30-4201-a6fc-23a307cc084a",
                    "69af8e10-be30-4201-a6fc-23a307cc084a"
                ]
            },
            "671c2539-9f72-4e31-a2bf-b22626105d41": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -170,
                    "y": -60
                },
                "z": 3,
                "parent": "69af8e10-be30-4201-a6fc-23a307cc084a",
                "embeds": [],
                "iscontainedinside": [
                    "69af8e10-be30-4201-a6fc-23a307cc084a",
                    "69af8e10-be30-4201-a6fc-23a307cc084a",
                    "69af8e10-be30-4201-a6fc-23a307cc084a"
                ]
            },
            "ad71c22b-9978-4aa9-a3b2-e8afc2bcd1da": {
                "size": {
                    "width": 240,
                    "height": 240
                },
                "position": {
                    "x": -320,
                    "y": 180
                },
                "z": 2,
                "parent": "ac93efbc-3f9d-4b15-a971-8c409e59459e",
                "embeds": [
                    "775dce1c-e8cb-416e-9ea6-ba6d6ac4349a"
                ],
                "iscontainedinside": [
                    "ac93efbc-3f9d-4b15-a971-8c409e59459e",
                    "ac93efbc-3f9d-4b15-a971-8c409e59459e",
                    "ac93efbc-3f9d-4b15-a971-8c409e59459e"
                ]
            },
            "775dce1c-e8cb-416e-9ea6-ba6d6ac4349a": {
                "size": {
                    "width": 60,
                    "height": 60
                },
                "position": {
                    "x": -290,
                    "y": 240
                },
                "z": 3,
                "parent": "ad71c22b-9978-4aa9-a3b2-e8afc2bcd1da",
                "embeds": [],
                "isassociatedwith": [
                    "921ba23d-e105-41cf-bd2f-278da2b3535f"
                ],
                "iscontainedinside": [
                    "ad71c22b-9978-4aa9-a3b2-e8afc2bcd1da",
                    "ad71c22b-9978-4aa9-a3b2-e8afc2bcd1da",
                    "ad71c22b-9978-4aa9-a3b2-e8afc2bcd1da"
                ]
            },
            "99fb1209-bc2a-4225-8688-61e43bf5cb61": {
                "source": {
                    "id": "69af8e10-be30-4201-a6fc-23a307cc084a"
                },
                "target": {
                    "id": "fba73ebe-558c-4800-bc0d-9cf084e4d781"
                },
                "z": 2
            },
            "0bb96200-6680-4959-970b-095357140bdb": {
                "source": {
                    "id": "ad71c22b-9978-4aa9-a3b2-e8afc2bcd1da"
                },
                "target": {
                    "id": "fba73ebe-558c-4800-bc0d-9cf084e4d781"
                },
                "z": 2
            }
        }
    },
    "Parameters": {
        "KeyName": {
            "Description": "EC2 KeyPair to enable SSH access to the instance",
            "Type": "AWS::EC2::KeyPair::KeyName"
        },
        "InstanceType": {
            "Description": "WebServer EC2 instance type",
            "Type": "String",
            "Default": "t2.micro",
            "AllowedValues": [
                "c5.18xlarge",
                "c5.2xlarge",
                "c5.4xlarge",
                "c5.9xlarge",
                "c5.large",
                "c5.xlarge",
                "d2.2xlarge",
                "d2.4xlarge",
                "d2.8xlarge",
                "d2.xlarge",
                "i3.16xlarge",
                "i3.2xlarge",
                "i3.4xlarge",
                "i3.8xlarge",
                "i3.large",
                "i3.xlarge",
                "m5.12xlarge",
                "m5.24xlarge",
                "m5.2xlarge",
                "m5.4xlarge",
                "m5.large",
                "m5.xlarge",
                "t3.2xlarge",
                "t3.large",
                "t3.medium",
                "t3.micro",
                "t3.nano",
                "t3.small",
                "t3.xlarge",
                "t2.micro"
            ],
            "ConstraintDescription": "must be a valid EC2 instance type."
        }
    },
    "Resources": {
        "myVPC": {
            "Type": "AWS::EC2::VPC",
            "Properties": {
                "CidrBlock": "10.0.0.0/16",
                "EnableDnsSupport": "true",
                "EnableDnsHostnames": "true",
                "Tags": [
                    {
                        "Key": "stack",
                        "Value": "production"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "ac93efbc-3f9d-4b15-a971-8c409e59459e"
                }
            }
        },
        "myInstance": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "ImageId": "ami-8c1be5f6",
                "InstanceType": {
                    "Ref": "InstanceType"
                },
                "KeyName": {
                    "Ref": "KeyName"
                },
                "NetworkInterfaces": [
                    {
                        "AssociatePublicIpAddress": "true",
                        "DeviceIndex": "0",
                        "GroupSet": [
                            {
                                "Ref": "mySG"
                            }
                        ],
                        "SubnetId": {
                            "Ref": "mySubnet"
                        }
                    }
                ],
                "IamInstanceProfile": {
                    "Ref": "RootInstanceProfile"
                },
                "UserData": {
                    "Fn::Base64": {
                        "Fn::Join": [
                            "\n",
                            [
                                "#!/bin/bash -xe",
                                "sudo yum update -y",
                                "sudo yum install httpd -y",
                                "sudo /etc/init.d/httpd start",
                                "echo \"<html><body><h1>Awesome !!!</h1>\" > /var/www/html/index.html",
                                "echo \"</body></html>\" >> /var/www/html/index.html"
                            ]
                        ]
                    }
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "0359154e-dc8d-4729-8a09-9a07ce8d7e02"
                }
            },
            "DependsOn": [
                "RootRole"
            ]
        },
        "mySubnet": {
            "Type": "AWS::EC2::Subnet",
            "Properties": {
                "VpcId": {
                    "Ref": "myVPC"
                },
                "CidrBlock": "10.0.0.0/24",
                "AvailabilityZone": "us-east-1a",
                "Tags": [
                    {
                        "Key": "stack",
                        "Value": "production"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "fba73ebe-558c-4800-bc0d-9cf084e4d781"
                }
            }
        },
        "mySubnetRouteTableAssociation": {
            "Type": "AWS::EC2::SubnetRouteTableAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "mySubnet"
                },
                "RouteTableId": {
                    "Ref": "myRouteTable"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "0bb96200-6680-4959-970b-095357140bdb"
                }
            }
        },
        "mySubnetNaclAssociation": {
            "Type": "AWS::EC2::SubnetNetworkAclAssociation",
            "Properties": {
                "SubnetId": {
                    "Ref": "mySubnet"
                },
                "NetworkAclId": {
                    "Ref": "myPublicNACL"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "99fb1209-bc2a-4225-8688-61e43bf5cb61"
                }
            }
        },
        "mySG": {
            "Type": "AWS::EC2::SecurityGroup",
            "Properties": {
                "GroupDescription": "Allow http to client host",
                "VpcId": {
                    "Ref": "myVPC"
                },
                "SecurityGroupIngress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0"
                    },
                    {
                        "IpProtocol": "tcp",
                        "FromPort": "22",
                        "ToPort": "22",
                        "CidrIp": "0.0.0.0/0"
                    }
                ],
                "SecurityGroupEgress": [
                    {
                        "IpProtocol": "tcp",
                        "FromPort": 80,
                        "ToPort": 80,
                        "CidrIp": "0.0.0.0/0"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "48858278-cbff-4117-8da1-34eb3bf67b64"
                }
            }
        },
        "RootRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
                "AssumeRolePolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Principal": {
                                "Service": [
                                    "ec2.amazonaws.com"
                                ]
                            },
                            "Action": [
                                "sts:AssumeRole"
                            ]
                        }
                    ]
                },
                "Path": "/"
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "f79965dd-2ac1-4a71-8c6c-95819d1642f7"
                }
            }
        },
        "RolePolicies": {
            "Type": "AWS::IAM::Policy",
            "Properties": {
                "PolicyName": "RolePolicies",
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect": "Allow",
                            "Action": "*",
                            "Resource": {
                                "Fn::Join": [
                                    "",
                                    [
                                        "arn:aws:s3:::",
                                        {
                                            "Ref": "myBucket"
                                        },
                                        "/*"
                                    ]
                                ]
                            }
                        }
                    ]
                },
                "Roles": [
                    {
                        "Ref": "RootRole"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "ef28d194-441d-430e-ba53-8be6db7a7c74"
                }
            }
        },
        "RootInstanceProfile": {
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/",
                "Roles": [
                    {
                        "Ref": "RootRole"
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "b8b4d6f9-cbc9-4878-a138-7d9cda08973b"
                }
            }
        },
        "myBucket": {
            "Type": "AWS::S3::Bucket",
            "Properties": {},
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "aabb2d30-64d9-40f1-be5d-19e5d304aced"
                }
            }
        },
        "myIGW": {
            "Type": "AWS::EC2::InternetGateway",
            "Properties": {
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "demo-igw"
                    },
                    {
                        "Key": "Application",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "921ba23d-e105-41cf-bd2f-278da2b3535f"
                }
            }
        },
        "vpcToIgw": {
            "Type": "AWS::EC2::VPCGatewayAttachment",
            "Properties": {
                "VpcId": {
                    "Ref": "myVPC"
                },
                "InternetGatewayId": {
                    "Ref": "myIGW"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "c8727300-fbdb-455f-acc8-5d3c90266ba2"
                }
            }
        },
        "myRouteTable": {
            "Type": "AWS::EC2::RouteTable",
            "Properties": {
                "VpcId": {
                    "Ref": "myVPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "demo-public-route-table"
                    },
                    {
                        "Key": "Application",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "ad71c22b-9978-4aa9-a3b2-e8afc2bcd1da"
                }
            }
        },
        "myRoutes": {
            "Type": "AWS::EC2::Route",
            "Properties": {
                "RouteTableId": {
                    "Ref": "myRouteTable"
                },
                "DestinationCidrBlock": "0.0.0.0/0",
                "GatewayId": {
                    "Ref": "myIGW"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "775dce1c-e8cb-416e-9ea6-ba6d6ac4349a"
                }
            }
        },
        "myPublicNACL": {
            "Type": "AWS::EC2::NetworkAcl",
            "Properties": {
                "VpcId": {
                    "Ref": "myVPC"
                },
                "Tags": [
                    {
                        "Key": "Name",
                        "Value": "demo-vpc-nacl"
                    },
                    {
                        "Key": "Application",
                        "Value": {
                            "Ref": "AWS::StackName"
                        }
                    }
                ]
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "69af8e10-be30-4201-a6fc-23a307cc084a"
                }
            }
        },
        "myNaclRulesForInboundTCP": {
            "Type": "AWS::EC2::NetworkAclEntry",
            "Properties": {
                "NetworkAclId": {
                    "Ref": "myPublicNACL"
                },
                "RuleNumber": "100",
                "Protocol": "6",
                "RuleAction": "allow",
                "Egress": "false",
                "CidrBlock": "0.0.0.0/0",
                "PortRange": {
                    "From": "0",
                    "To": "65535"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "671c2539-9f72-4e31-a2bf-b22626105d41"
                }
            }
        },
        "myNaclRulesForOutboundTCP": {
            "Type": "AWS::EC2::NetworkAclEntry",
            "Properties": {
                "NetworkAclId": {
                    "Ref": "myPublicNACL"
                },
                "RuleNumber": "100",
                "Protocol": "6",
                "RuleAction": "allow",
                "Egress": "true",
                "CidrBlock": "0.0.0.0/0",
                "PortRange": {
                    "From": "0",
                    "To": "65535"
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Designer": {
                    "id": "0550ae34-a326-4bbf-863e-64ee16839d20"
                }
            }
        }
    },
    "Outputs": {
        "URL": {
            "Description": "URL of the sample website",
            "Value": {
                "Fn::Join": [
                    "",
                    [
                        "http://",
                        {
                            "Fn::GetAtt": [
                                "myInstance",
                                "PublicDnsName"
                            ]
                        }
                    ]
                ]
            }
        }
    }
}
